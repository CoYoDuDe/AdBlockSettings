#!/bin/bash
# Einrichtungsskript f端r AdBlockSettings

# Einbinden der Helper-Ressourcen
source "/data/SetupHelper/HelperResources/IncludeHelpers"

# Standardaktionen aktivieren
standardPromptAndActions='yes'

# Installationsverzeichnis festlegen
ROOT_PATH=/data/AdBlockSettings

# Funktion, symlink zu rc.local hinzuzuf端gen
add_symlink_entry_to_rc_local() {
    local RC_LOCAL_PATH="/data/rc.local"
    local ENTRY="ln -s /data/AdBlockSettings/service/AdBlockSettings /service/AdBlockSettings"

    [ ! -f "$RC_LOCAL_PATH" ] && echo "$ENTRY" > "$RC_LOCAL_PATH" || [ ! "$(grep "$ENTRY" "$RC_LOCAL_PATH")" ] && echo "$ENTRY" >> "$RC_LOCAL_PATH"
    chmod +x "$RC_LOCAL_PATH"
}

# Funktion, symlink aus rc.local zu entfernen
remove_symlink_entry_from_rc_local() {
    local RC_LOCAL_PATH="/data/rc.local"
    local ENTRY="ln -s /data/AdBlockSettings/service/AdBlockSettings /service/AdBlockSettings"

    [ -f "$RC_LOCAL_PATH" ] && sed -i "/^$(echo "$ENTRY" | sed 's/[\/&]/\\&/g')$/d" "$RC_LOCAL_PATH"
}

# Funktion, um den dnsmasq-Starteintrag zu rc.local hinzuzuf端gen
add_dnsmasq_entry_to_rc_local() {
    local RC_LOCAL_PATH="/data/rc.local"
    local ENTRY="/etc/init.d/dnsmasq start"

    [ ! -f "$RC_LOCAL_PATH" ] && echo "$ENTRY" > "$RC_LOCAL_PATH" || [ ! "$(grep "$ENTRY" "$RC_LOCAL_PATH")" ] && echo "$ENTRY" >> "$RC_LOCAL_PATH"
    chmod +x "$RC_LOCAL_PATH"
}

# Funktion, um den dnsmasq-Starteintrag aus rc.local zu entfernen
remove_dnsmasq_entry_from_rc_local() {
    local RC_LOCAL_PATH="/data/rc.local"
    local ENTRY="/etc/init.d/dnsmasq start"

    [ -f "$RC_LOCAL_PATH" ] && sed -i "/^$(echo "$ENTRY" | sed 's/[\/&]/\\&/g')$/d" "$RC_LOCAL_PATH"
}

# Installationsroutine
perform_installation() {
    logMessage "Installation beginnt..."
    addAllDbusSettings

    add_symlink_entry_to_rc_local
    add_dnsmasq_entry_to_rc_local

    local QML_PATH="/opt/victronenergy/gui/qml/PageSettingsAdBlock.qml"
    local PATCH_PATH="/opt/victronenergy/gui/qml/PageSettings.qml"
    local PATCH_SOURCE="/data/AdBlockSettings/FileSets/PatchSource/PageSettings.qml.patch"

    if [ -f "$PATCH_SOURCE" ]; then
        if [ ! -f "$QML_PATH" ] || ! grep -q "//////// modified to insert AdBlockSettings menu" "$PATCH_PATH"; then
            cp -f /data/AdBlockSettings/FileSets/VersionIndependent/*.qml /opt/victronenergy/gui/qml/
            patch "$PATCH_PATH" < "$PATCH_SOURCE"
            logMessage "QML-Dateien und Patch wurden installiert."
        else
            logMessage "QML-Dateien und Patch sind bereits aktuell."
        fi
    else
        logMessage "Fehler: Patch-Quelle nicht gefunden."
        installFailed=true
    fi

    local DNSMASQ_CONF="/etc/dnsmasq_static.conf"
    local NEW_DNSMASQ_CONF="/data/AdBlockSettings/FileSets/configs/dnsmasq_static.conf"
    if [ -f "$NEW_DNSMASQ_CONF" ]; then
        if ! cmp -s "$NEW_DNSMASQ_CONF" "$DNSMASQ_CONF"; then
            cp -f "$NEW_DNSMASQ_CONF" "$DNSMASQ_CONF"
            logMessage "dnsmasq_static.conf wurde aktualisiert."
        else
            logMessage "dnsmasq_static.conf ist bereits aktuell."
        fi
    else
        logMessage "Fehler: dnsmasq_static.conf Quelle nicht gefunden."
        installFailed=true
    fi

    restartGuiNeeded=true
}

# Deinstallationsroutine
perform_uninstallation() {
    logMessage "Deinstallation beginnt..."

    remove_symlink_entry_from_rc_local
    remove_dnsmasq_entry_from_rc_local

    rm -f /opt/victronenergy/gui/qml/PageSettingsAdBlock.qml

    local DNSMASQ_CONF="/etc/dnsmasq.conf"
    if [ -f "${DNSMASQ_CONF}.orig" ]; then
        mv "${DNSMASQ_CONF}.orig" "$DNSMASQ_CONF"
    fi

    /etc/init.d/dnsmasq restart

    logMessage "Deinstallation abgeschlossen."
    restartGuiNeeded=true
}

case "$scriptAction" in
    INSTALL|CHECK)
        perform_installation
        ;;
    UNINSTALL)
        perform_uninstallation
        ;;
    *)
        logMessage "Unbekannte Aktion: $scriptAction. Beende Skript."
        exit 1
        ;;
esac

logMessage "Skriptausf端hrung abgeschlossen."
endScript
