#!/bin/bash

# Einrichtungsskript für AdBlockSettings
# Einbinden der Helper-Ressourcen
source "/data/SetupHelper/HelperResources/IncludeHelpers"

# Standardaktionen aktivieren
standardPromptAndActions='yes'

# Installationsverzeichnis festlegen
ROOT_PATH=/data/AdBlockSettings

# Pfaddefinitionen
RC_LOCAL_PATH="/data/rc.local"
QML_PATH="/opt/victronenergy/gui/qml/PageSettingsAdBlock.qml"
PATCH_PATH="/opt/victronenergy/gui/qml/PageSettings.qml"
PATCH_SOURCE="${ROOT_PATH}/FileSets/PatchSource/PageSettings.qml.patch"
DNSMASQ_CONF="/etc/dnsmasq_static.conf"
NEW_DNSMASQ_CONF="${ROOT_PATH}/FileSets/configs/dnsmasq_static.conf"

# Funktionen definieren
add_entry_to_rc_local() {
    local ENTRY="$1"
    [ ! -f "$RC_LOCAL_PATH" ] && echo "$ENTRY" > "$RC_LOCAL_PATH" || [ ! "$(grep "$ENTRY" "$RC_LOCAL_PATH")" ] && echo "$ENTRY" >> "$RC_LOCAL_PATH"
    chmod +x "$RC_LOCAL_PATH"
}

remove_entry_from_rc_local() {
    local ENTRY="$1"
    [ -f "$RC_LOCAL_PATH" ] && sed -i "/^$(echo "$ENTRY" | sed 's/[\/&]/\\&/g')$/d" "$RC_LOCAL_PATH"
}

install_config() {
    logMessage "Installation beginnt..."
    addAllDbusSettings

    add_entry_to_rc_local "ln -s ${ROOT_PATH}/service/AdBlockSettings /service/AdBlockSettings"
    add_entry_to_rc_local "/etc/init.d/dnsmasq start"

    if [ -f "$PATCH_SOURCE" ]; then
        if [ ! -f "$QML_PATH" ] || ! grep -q "//////// modified to insert AdBlockSettings menu" "$PATCH_PATH"; then
            cp -f "${ROOT_PATH}/FileSets/VersionIndependent/*.qml" /opt/victronenergy/gui/qml/
            patch "$PATCH_PATH" < "$PATCH_SOURCE"
            logMessage "QML-Dateien und Patch wurden installiert."
        else
            logMessage "QML-Dateien und Patch sind bereits aktuell."
        fi
    else
        logMessage "Fehler: Patch-Quelle nicht gefunden."
        installFailed=true
    fi

    if [ -f "$NEW_DNSMASQ_CONF" ]; then
        if ! cmp -s "$NEW_DNSMASQ_CONF" "$DNSMASQ_CONF"; then
            cp -f "$NEW_DNSMASQ_CONF" "$DNSMASQ_CONF"
            logMessage "dnsmasq_static.conf wurde aktualisiert."
        else
            logMessage "dnsmasq_static.conf ist bereits aktuell."
        fi
    else
        logMessage "Fehler: dnsmasq_static.conf Quelle nicht gefunden."
        installFailed=true
    fi

    restartGuiNeeded=true
}

uninstall() {
    logMessage "Deinstallation beginnt..."

    remove_entry_from_rc_local "ln -s ${ROOT_PATH}/service/AdBlockSettings /service/AdBlockSettings"
    remove_entry_from_rc_local "/etc/init.d/dnsmasq start"

    rm -f /opt/victronenergy/gui/qml/PageSettingsAdBlock.qml

    if [ -f "${DNSMASQ_CONF}.orig" ]; then
        mv "${DNSMASQ_CONF}.orig" "$DNSMASQ_CONF"
    fi

    /etc/init.d/dnsmasq restart

    logMessage "Deinstallation abgeschlossen."
    restartGuiNeeded=true
}

case "$scriptAction" in
    INSTALL|CHECK)
        install_config
        ;;
    UNINSTALL)
        uninstall
        ;;
    *)
        logMessage "Unbekannte Aktion: $scriptAction. Beende Skript."
        exit 1
        ;;
esac

logMessage "Skriptausführung abgeschlossen."
endScript
